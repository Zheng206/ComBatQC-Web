{
  "hash": "0fd8e451977f4665b4b9143f68ed366e",
  "result": {
    "markdown": "---\ntitle: \"Batch Effect Diagnostics\"\nformat: html\n---\n\n```{=html}\n<!-- Right-side fixed toggle -->\n<div class=\"mode-toggle\" role=\"group\" aria-label=\"Select mode\">\n  <div class=\"btn-group\">\n    <button id=\"btn-r\" class=\"btn btn-primary\" type=\"button\">R Code</button>\n    <button id=\"btn-cli\" class=\"btn btn-outline-primary\" type=\"button\">CLI</button>\n  </div>\n</div>\n```\n\n\nIn this section, we will use a sample data included in this package to provide a thorough introduction to the key functionalities of the **[ComBatFamQC]{style=\"color:#C83F49\"}** package for batch effect diagnostics.\n\n# Data\n___\n\nThe sample dataset in the package is the longitudinal cortical thickness data from the\n[Alzheimer’s Disease Neuroimaging Initiative](https://adni.loni.usc.edu/\n) (ADNI) study (Jack et al. (2008)), which con-\ntains cortical thickness measures of 62 regions from 663 unique participants with images\ncollected longitudinally between 2-6 visits. The processed data can be downloaded from [GitHub](\nhttps://github.com/ntustison/CrossLong). \n\nThe key variables of interest are presented below:\n\n-   Batch variable: \n    -   <span style=\"color:blueviolet;\">*manufac*</span>: MRI manufacturer\n-   Covariates\n    -   <span style=\"color:darkseagreen;\">*timedays*</span>: time related variable\n    -   <span style=\"color:darkseagreen;\">*Age*</span>\n    -   <span style=\"color:darkseagreen;\">*SEX*</span> \n    -   <span style=\"color:darkseagreen;\">*DIAGNOSIS*</span>: (AD, CN, LMCI)\n    \n    (We consider an interaction effect between *timedays* and *DIAGNOSIS*)\n-   Features to harmonize\n    -   62 <span style=\"color:coral;\">cortical thickness</span> regions\n-   Random Effect\n    -   <span style=\"color:cornflowerblue;\">*subid*</span> : Subject IDs.\n\n# Interactive Batch Effect Diagnostics\n___\n\nThe diagnostic workflow is the same whether you use R or the CLI:\n\n1. **Set up variables**:\nSelect features, batch, covariates, interactions, and random effects.\n\n2. **Fit the diagnostic model**:\nA linear mixed-effects model (`lmer`) evaluates batch effects while accounting for repeated measures.\n\n3. **View diagnostics**:\nInspect plots showing batch trends, covariate effects, and distribution differences.\n\n4. **Interpret results**:\nUse the summaries and visualizations to determine whether harmonization is needed.\n\nYou can run this workflow through R  or through the CLI.\nExpand the panels below to see the corresponding code.\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: Model Fitting & Diagnostics\nThe R interface prepares the data, fits the models, and launches an interactive Shiny app for diagnostics using `visual_prep()`and `comfam_shiny()`.\n\n::: {.cell class='highlight-chunk'}\n\n```{.r .cell-code}\nfeatures <- colnames(adni)[c(43:104)]\ncovariates <- c(\"timedays\", \"AGE\", \"SEX\", \"DIAGNOSIS\")\ninteraction <- c(\"timedays,DIAGNOSIS\")\nbatch <- \"manufac\"\nresult_lmer <- visual_prep(\n  type = \"lmer\",\n  features = features,\n  batch = batch,\n  covariates = covariates,\n  interaction = interaction,\n  smooth = NULL,\n  random = \"subid\",\n  df = adni\n)\ncomfam_shiny(result_lmer)\n```\n:::\n\nWhat this does (summary):\n\n- Selects columns <span style=\"color:coral;\">43–104</span>  as features (62 cortical thickness regions).\n\n- Uses <span style=\"color:blueviolet;\">manufac</span>  as the batch variable.\n\n- Includes <span style=\"color:darkseagreen;\">timedays</span> , <span style=\"color:darkseagreen;\">AGE</span> , <span style=\"color:darkseagreen;\">SEX</span> , and <span style=\"color:darkseagreen;\">DIAGNOSIS</span> , plus the <span style=\"color:darkseagreen;\">timedays × DIAGNOSIS</span>  interaction.\n\n- Treats <span style=\"color:cornflowerblue;\">subid</span>  as a random effect for subject-level correlation.\n\n- Launches a Shiny app to explore diagnostic plots interactively.\n:::\nIf you prefer **CLI**, you can run the same workflow directly from the terminal.\nThis approach is especially convenient for automation, scripting, or large-scale batch runs.\n\n\n\n::: {.callout-tip .cli-only collapse=\"true\"}\n## CLI code: Model Fitting & Diagnostics\nThe CLI interface mirrors the R workflow but is designed for scripting and batch runs.\n\n::: {.cell class='highlight-chunk'}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R path/to/unharmonized_data.csv \\\n  -d TRUE -v TRUE \\\n  --features 43-104 \\\n  --covariates 9,11,13-14 \\\n  -b 16 -i 9*14 -r 3 -m lmer\n```\n:::\n\nMain options overview:\n\n- `--diagnosis/-d`: whether to include diagnosis effects (default `TRUE`)  \n- `--visualization/-v`: whether to generate diagnostic visuals (default `TRUE`)  \n- `--features/-f`: feature columns (e.g., 43–104)  \n- `--covariates/-c`: covariate columns  \n- `--batch/-b`: batch column  \n- `--smooth/-s`: smooth term column (for `gam`)  \n- `--random/-r`: random-effect column (for `lmer`)\n:::\n\nAfter running either workflow, **[ComBatFamQC]{style=\"color:#C83F49\"}** will produce diagnostic plots and summaries that help you visually and quantitatively assess batch effects before harmonization.\n\n# Exporting Results\n___\n\nOnce diagnostics are complete, you may want to:\n\n- Save tabular summaries (e.g., per-feature statistics, model summaries), or\n\n- Produce a standalone report that documents the diagnostic analysis.\n\nComBatFamQC supports both use cases via R functions and CLI options.\n\n### Export from R\n\nYou can export results either as an [Excel file]{style=\"color:#8D38C9\"} or a [Quarto report]{style=\"color:#8D38C9\"}.\nBoth options use the same underlying diagnostics object produced in the previous step\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: Excel Report\n\n::: {.cell}\n\n```{.r .cell-code}\ndiag_save(path = \"path/to/dir\", result = result_lmer, use_quarto = FALSE)\n```\n:::\n\n:::\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: Quarto Report\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(quarto)\ndiag_save(path = \"path/to/dir\", result = result_lmer, use_quarto = TRUE)\n```\n:::\n\n:::\n\n### Export from CLI\n\nFrom the command line, you can run diagnostics and export results in a single step or perform diagnostics first and export later. The CLI supports both Excel-style outputs and Quarto report generation.\n\n::: {.callout-tip .cli-only collapse=\"true\"}\n## CLI code: Export Diagnostics\n\n::: {.cell class='highlight-chunk'}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R path/to/unharmonized_data.csv \\\n  -d TRUE -v FALSE \\\n  --features 43-104 \\\n  --covariates 9,11,13-14 \\\n  -b 16 -i 9*14 -r 3 -m lmer \\\n  --outdir /path/to/dir\\\n  --quarto TRUE\n```\n:::\n\nMain options overview:\n\n- `--visualization/-v`: set to `FALSE` when exporting only  \n- `--outdir`: directory for outputs  \n- `--quarto/-q`: whether to generate a Quarto report\n:::\n\n\n<style>\n.mode-toggle {\n  position: sticky;\n  top: 0;\n  z-index: 1000;\n  background: var(--quarto-body-bg, #fff);\n  padding: .5rem 0;\n  border-bottom: 1px solid rgba(0,0,0,.05);\n}\n.hidden-by-toggle { display: none !important; }\n</style>\n\n<script>\n(function(){\n  const btnR = document.getElementById('btn-r');\n  const btnCli = document.getElementById('btn-cli');\n\n  // Restore preferences from localStorage\n  let showR = true;\n  let showCli = false;\n\n  try {\n    const saved = JSON.parse(localStorage.getItem('preferredModes'));\n    if (saved) {\n      showR = saved.showR ?? true;\n      showCli = saved.showCli ?? false;\n    }\n  } catch(e){}\n\n  function updateVisibility() {\n    const rEls = document.querySelectorAll('.r-only');\n    const cliEls = document.querySelectorAll('.cli-only');\n\n    rEls.forEach(el => el.classList.toggle('hidden-by-toggle', !showR));\n    cliEls.forEach(el => el.classList.toggle('hidden-by-toggle', !showCli));\n\n    // Button styles\n    btnR.classList.toggle('btn-primary', showR);\n    btnR.classList.toggle('btn-outline-primary', !showR);\n    btnCli.classList.toggle('btn-primary', showCli);\n    btnCli.classList.toggle('btn-outline-primary', !showCli);\n\n    // Save preferences\n    try {\n      localStorage.setItem('preferredModes', JSON.stringify({showR, showCli}));\n    } catch(e){}\n  }\n\n  btnR.addEventListener('click', ()=>{\n    showR = !showR;\n    updateVisibility();\n  });\n\n  btnCli.addEventListener('click', ()=>{\n    showCli = !showCli;\n    updateVisibility();\n  });\n\n  updateVisibility();\n})();\n</script>\n\n\n# Learn More\n- Check out the [**Example: Harmonization**](harmonization.qmd) for a hands-on look at how to apply harmonization methods effectively.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}