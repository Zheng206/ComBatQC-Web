{
  "hash": "581cb8c37264b26ac316110e6659d691",
  "result": {
    "markdown": "---\ntitle: \"Harmonization\"\nformat: html\n---\n\n\n**ComBatFamQC** provides four types of commonly used harmonization techniques, integrated through the [ComBatFamily](https://github.com/andy1764/ComBatFamily) package developed by Dr. Andrew Chen, for users to consider. The four harmonization techniques include:\n\n-   Original ComBat (Johnson et al., 2007)\n-   Longitudinal ComBat (Beer et al., 2020)\n-   ComBat-GAM (Pomponio et al., 2020)\n-   CovBat (Chen et al., 2021)\n\nThere are two types of harmonization scenarios users can choose from:\n\n-   **First-time Harmonization** (Can also do interactive harmonization through Rshiny)\n-   **Out of Sample Harmonization**\n    -   predict from existing ComBat model (works only for <span style=\"color:blueviolet;\">original ComBat</span> and <span style=\"color:blueviolet;\">ComBat-GAM</span>)\n    -   harmonize new data toward existing reference data (works for all built-in ComBat harmonization methods)\n\n# First Harmonization\n\nSpecify parameters carefully based on the harmonization method to be applied.\n\n## Original ComBat\n\nA method designed for batch effect correction in cross-sectional data with linear covariate effects.\n\n::: {.callout-note collapse=\"true\"}\n## R code\n\n::: {.cell}\n\n```{.r .cell-code}\nfeatures = colnames(adni)[c(43:104)]\ncovariates = c(\"timedays\", \"AGE\", \"SEX\", \"DIAGNOSIS\")\ninteraction = c(\"timedays,DIAGNOSIS\")\nbatch = \"manufac\"\ncombat_model = combat_harm(type = \"lm\", features = features, batch = batch, covariates = covariates, interaction = interaction, smooth = NULL, random = NULL, df = adni)\nhead(combat_model$harmonized_df)\n```\n:::\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## CLI code\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R path/to/unharmonized_data.csv -v FALSE --features 43-104 \n--covariates 9,11,13-14 -b 16 -i 9*14 -m lm --outdir /path/to/harmonized_data.csv --mout /path/to/saved_model.rds\n```\n:::\n\n:::\n\n## Longitudinal ComBat\n\nA method accounts for intra-subject correlation in longitudinal data by incorporating random effects into the model.\n\n::: {.callout-note collapse=\"true\"}\n## R code\n\n::: {.cell}\n\n```{.r .cell-code}\ncombat_model_lmer = combat_harm(type = \"lmer\", features = features, batch = batch, covariates = covariates, interaction = interaction, smooth = NULL, random = \"subid\", df = adni)\nhead(combat_model_lmer$harmonized_df)\n```\n:::\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## CLI code\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R path/to/unharmonized_data.csv -v FALSE --features 43-104 \n--covariates 9,11,13-14 -b 16 -i 9*14 -m lmer -r 3 --outdir /path/to/harmonized_data.csv --mout /path/to/saved_model.rds\n```\n:::\n\n:::\n\n\n## ComBat-GAM\n\nA method allows for preservation of non-linear covariate effects through use of the generalized additive model.\n\n::: {.callout-note collapse=\"true\"}\n## R code\n\n::: {.cell}\n\n```{.r .cell-code}\ncombat_model_gam = combat_harm(type = \"gam\", features = features, batch = batch, covariates = covariates, interaction = interaction, smooth = \"AGE\", smooth_int_type = \"linear\", df = adni)\nhead(combat_model_gam$harmonized_df)\n```\n:::\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## CLI code\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R path/to/unharmonized_data.csv -v FALSE --features 43-104 \n--covariates 9,11,13-14 -b 16 -i 9*14 -m gam -s 11 --outdir /path/to/harmonized_data.csv --mout /path/to/saved_model.rds\n```\n:::\n\n:::\n\n## CovBat\n\nCovBat is used for correcting covariance batch effects.\n\n::: {.callout-note collapse=\"true\"}\n## R code\n\n::: {.cell}\n\n```{.r .cell-code}\ncovbat_model = combat_harm(type = \"gam\", features = features, batch = batch, covariates = covariates, interaction = interaction, smooth_int_type = \"linear\", smooth = \"AGE\", df = adni, family = \"covfam\")\nhead(covbat_model$harmonized_df)\n```\n:::\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## CLI code\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R path/to/unharmonized_data.csv -v FALSE --features 43-104 \n--covariates 9,11,13-14 -b 16 -i 9*14 -m gam -s 11 -f covfam --outdir /path/to/harmonized_data.csv --mout /path/to/saved_model.rds\n```\n:::\n\n:::\n\n# Out-of-Sample Harmonization\n\n## from ComBat Model\n\nSpecify `predict` parameter to be TRUE and `object` parameter to be saved ComBat model.\n\n::: {.callout-note collapse=\"true\"}\n## R code\n\n::: {.cell}\n\n```{.r .cell-code}\nsaved_model = combat_model_gam$combat.object\nharm_predict = combat_harm(df = adni %>% head(1000), predict = TRUE, object = saved_model)\n```\n:::\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## CLI code\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R path/to/unharmonized_data.csv -v FALSE --predict TRUE -o path/to/saved_model.rds --outdir /path/to/harmonized_data.csv\n```\n:::\n\n:::\n\n## from Reference Data\n\nSpecify `reference` parameter to be saved reference data. To be noticed, the reference data should have identical columns as the new data and the new data should contain reference data as its sub sample.\n\n::: {.callout-note collapse=\"true\"}\n## R code\n\n::: {.cell}\n\n```{.r .cell-code}\n# harmonize reference data\nreference_site = adni %>% group_by(site) %>% summarize(count = n()) %>% arrange(desc(count)) %>% pull(site) %>% head(30)\nreference_df = adni %>% filter(site %in% reference_site)\nfeatures = colnames(reference_df)[c(43:104)]\ncovariates = c(\"timedays\", \"AGE\", \"SEX\", \"DIAGNOSIS\")\ninteraction = c(\"timedays,DIAGNOSIS\")\nbatch = \"site\"\nref_model = combat_harm(type = \"lmer\", features = features, batch = batch, covariates = covariates, interaction = interaction, smooth = NULL, random = \"subid\", df = reference_df)\n\n# harmonize new data to the reference data\nharm_new = combat_harm(type = \"lmer\", features = features, batch = batch, covariates = covariates, interaction = interaction, smooth = NULL, random = \"subid\", df = adni, reference = ref_model$harmonized_df)\n```\n:::\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## CLI code\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R path/to/unharmonized_data.csv -v FALSE --features 43-104 --covariates 9,11,13-14 -b 16 -i 9*14 -m lmer -r 3 --reference path/to/reference.csv --outdir /path/to/harmonized_data.csv --mout /path/to/saved_model.rds\n```\n:::\n\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}