{
  "hash": "71854e5c3a6df44f6314c85655f45c95",
  "result": {
    "markdown": "---\ntitle: \"Harmonization\"\nformat: html\n---\n\n```{=html}\n<!-- Right-side fixed toggle -->\n<div class=\"mode-toggle\" role=\"group\" aria-label=\"Select mode\">\n  <div class=\"btn-group\">\n    <button id=\"btn-r\" class=\"btn btn-primary\" type=\"button\">R Code</button>\n    <button id=\"btn-cli\" class=\"btn btn-outline-primary\" type=\"button\">CLI</button>\n  </div>\n</div>\n```\n\n\n**[ComBatFamQC]{style=\"color:#C83F49\"}** provides four types of commonly used harmonization techniques, integrated through the [ComBatFamily](https://github.com/andy1764/ComBatFamily) package developed by Dr. Andrew Chen, for users to consider. The four harmonization techniques include:\n\n-   [ComBat (Johnson et al., 2007)](https://academic.oup.com/biostatistics/article-abstract/8/1/118/252073?redirectedFrom=fulltext&login=false)\n-   [Longitudinal ComBat (Beer et al., 2020)](https://doi.org/10.1016/j.neuroimage.2020.117129)\n-   [ComBat-GAM (Pomponio et al., 2020)](https://pmc.ncbi.nlm.nih.gov/articles/PMC6980790/)\n-   [CovBat (Chen et al., 2021)](https://onlinelibrary.wiley.com/doi/10.1002/hbm.25688)\n\nThere are two types of harmonization scenarios users can choose from:\n\n-   **First-time Harmonization** (Can also do interactive harmonization through Rshiny)\n-   **Out of Sample Harmonization**\n    -   predict from existing ComBat model (currently not supports [Longitudinal ComBat]{style=\"color:blueviolet\"})\n    -   harmonize new data toward existing reference data (works for all built-in ComBat harmonization methods)\n\n# First Time Harmonization\n___\n\nIn order to run harmonization, you need to specify your harmonization parameters based on the method you plan to use.\n\nIn R, harmonization is performed with the `combat_harm()` function, where you provide the features, batch variable, covariates, interaction terms, and optional smooth or random effects depending on the selected ComBat method\n\nUsers can also use the command-line interface via **ComBatQC_CLI.R** to start the harmonization stage. Apart from the same required parameters as the diagnosis stage(`features`, `covariates`, `batch`, `smooth`, `random`), using the command-line interface also requires users to set the following parameter:\n\n-   `--diagnosis/-d`: `FALSE`\n-   `--outdir`: Path to save the harmonized dataset (in .csv format)\n-   `--mout`: Path to save the ComBat model (optional if users do not wish to save the model; in .rds format)\n\n## ComBat\n\nA method designed for batch effect correction in [cross-sectional]{style=\"color:#E56E94\"} data with linear covariate effects.\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: ComBat\n\n::: {.cell}\n\n```{.r .cell-code}\nfeatures <- colnames(adni)[c(43:104)]\ncovariates <- c(\"timedays\", \"AGE\", \"SEX\", \"DIAGNOSIS\")\ninteraction <- c(\"timedays,DIAGNOSIS\")\nbatch <- \"manufac\"\ncombat_model <- combat_harm(\n  type        = \"lm\",\n  features    = features,\n  batch       = batch,\n  covariates  = covariates,\n  interaction = interaction,\n  smooth      = NULL,\n  random      = NULL,\n  df          = adni\n)\nhead(combat_model$harmonized_df)\n```\n:::\n\n:::\n\n::: {.callout-tip .cli-only collapse=\"true\"}\n## CLI code: ComBat\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R \\\n  path/to/unharmonized_data.csv \\\n  -d FALSE \\\n  --features 43-104 \\\n  --covariates 9,11,13-14 \\\n  -b 16 \\\n  -i 9*14 \\\n  -m lm \\\n  --outdir /path/to/harmonized_data.csv \\\n  --mout  /path/to/saved_model.rds\n```\n:::\n\n:::\n\n## Longitudinal ComBat\n\nA method accounts for intra-subject correlation in [longitudinal data]{style=\"color:#E56E94\"} by incorporating random effects into the model.\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: Longitudinal ComBat\n\n::: {.cell}\n\n```{.r .cell-code}\ncombat_model_lmer <- combat_harm(\n  type        = \"lmer\",\n  features    = features,\n  batch       = batch,\n  covariates  = covariates,\n  interaction = interaction,\n  smooth      = NULL,\n  random      = \"subid\",\n  df          = adni\n)\n\nhead(combat_model_lmer$harmonized_df)\n```\n:::\n\n:::\n\n::: {.callout-tip .cli-only collapse=\"true\"}\n## CLI code: Longitudinal ComBat\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R \\\n  path/to/unharmonized_data.csv \\\n  -d FALSE \\\n  --features 43-104 \\\n  --covariates 9,11,13-14 \\\n  -b 16 \\\n  -i 9*14 \\\n  -m lmer \\\n  -r 3 \\\n  --outdir /path/to/harmonized_data.csv \\\n  --mout  /path/to/saved_model.rds\n```\n:::\n\n:::\n\n\n## ComBat-GAM\n\nA method allows for preservation of [non-linear covariate effects]{style=\"color:#E56E94\"} through use of the generalized additive model.\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: ComBat-GAM\n\n::: {.cell}\n\n```{.r .cell-code}\ncombat_model_gam <- combat_harm(\n  type            = \"gam\",\n  features        = features,\n  batch           = batch,\n  covariates      = covariates,\n  interaction     = interaction,\n  smooth          = \"AGE\",\n  smooth_int_type = \"linear\",\n  df              = adni\n)\n\nhead(combat_model_gam$harmonized_df)\n```\n:::\n\n:::\n\n::: {.callout-tip .cli-only collapse=\"true\"}\n## CLI code: ComBat-GAM\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R \\\n  path/to/unharmonized_data.csv \\\n  -d FALSE \\\n  --features 43-104 \\\n  --covariates 9,11,13-14 \\\n  -b 16 \\\n  -i 9*14 \\\n  -m gam \\\n  -s 11 \\\n  --outdir /path/to/harmonized_data.csv \\\n  --mout  /path/to/saved_model.rds\n```\n:::\n\n:::\n\n## CovBat\n\nCovBat is used for correcting [covariance batch effects]{style=\"color:#E56E94\"}.\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: CovBat\n\n::: {.cell}\n\n```{.r .cell-code}\ncovbat_model <- combat_harm(\n  type            = \"gam\",\n  features        = features,\n  batch           = batch,\n  covariates      = covariates,\n  interaction     = interaction,\n  smooth          = \"AGE\",\n  smooth_int_type = \"linear\",\n  df              = adni,\n  family          = \"covfam\"\n)\n\nhead(covbat_model$harmonized_df)\n```\n:::\n\n:::\n\n::: {.callout-tip .cli-only collapse=\"true\"}\n## CLI code: CovBat\n\n::: {.cell}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R \\\n  path/to/unharmonized_data.csv \\\n  -d FALSE \\\n  --features 43-104 \\\n  --covariates 9,11,13-14 \\\n  -b 16 \\\n  -i 9*14 \\\n  -m gam \\\n  -s 11 \\\n  -f covfam \\\n  --outdir /path/to/harmonized_data.csv \\\n  --mout  /path/to/saved_model.rds\n```\n:::\n\n:::\n\n# Out-of-Sample Harmonization\n___\n\n## from ComBat Model\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: Out-of-sample ComBat\nSpecify `predict` parameter to be `TRUE` and `object` parameter to be saved ComBat model.\n\n::: {.cell class='highlight-chunk'}\n\n```{.r .cell-code}\nsaved_model <- combat_model_gam$combat.object\n\nharm_predict <- combat_harm(\n  df      = adni %>% head(1000),\n  predict = TRUE,\n  object  = saved_model\n)\n```\n:::\n\n:::\n\n\n::: {.callout-tip .cli-only collapse=\"true\"}\n## CLI code: Out-of-sample ComBat\nUsing the command-line interface requires users to set the following parameter:\n\n-   `--predict`: `TRUE`\n-   `--object/-o`: Path to the saved ComBat model (in .rds format)\n\n::: {.cell class='highlight-chunk'}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R \\\n  path/to/unharmonized_data.csv \\\n  -d FALSE \\\n  --predict TRUE \\\n  -o path/to/saved_model.rds \\\n  --outdir /path/to/harmonized_data.csv\n```\n:::\n\n:::\n\n## from CovBat Model\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: Out-of-sample CovBat\nSpecify `predict` parameter to be `TRUE` and `object` parameter to be saved CovBat model.\n\n::: {.cell class='highlight-chunk'}\n\n```{.r .cell-code}\nsaved_model <- covbat_model$combat.object\n\nharm_predict <- combat_harm(\n  df      = adni,\n  predict = TRUE,\n  object  = saved_model\n)\n```\n:::\n\n:::\n\n\n::: {.callout-tip .cli-only collapse=\"true\"}\n## CLI code: Out-of-Sample CovBat\nUsing the command-line interface requires users to set the following parameter:\n\n-   `-d`/`--diagnosis`: set to `FALSE` to run harmonization (use `TRUE` to run batch effect diagnostics only)\n-   `--predict`: set to `TRUE` for out-of-sample harmonization using a saved covbat model\n-   `--object/-o`: Path to the saved CovBat model file (.rds)\n-   `--outdir`: Path to write the harmonized data (.csv)\n\n::: {.cell class='highlight-chunk'}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R \\\n  path/to/unharmonized_data.csv \\\n  -d FALSE \\\n  --predict TRUE \\\n  -o path/to/saved_model.rds \\\n  --outdir /path/to/harmonized_data.csv\n```\n:::\n\n:::\n\n## from Reference Data\n\n::: {.callout-note .r-only collapse=\"true\"}\n## R code: Out-of-sample using Reference Data\nSpecify `reference` parameter to be saved reference data. To be noticed, the reference data should have identical columns as the new data and the new data should contain reference data as its sub sample.\n\n::: {.cell class='highlight-chunk'}\n\n```{.r .cell-code}\n# identify reference site(s)\nreference_site <- adni %>%\n  group_by(site) %>%\n  summarize(count = n()) %>%\n  arrange(desc(count)) %>%\n  pull(site) %>%\n  head(30)\n\nreference_df <- adni %>%\n  filter(site %in% reference_site)\n\n# specify harmonization variables\nfeatures    <- colnames(reference_df)[c(43:104)]\ncovariates  <- c(\"timedays\", \"AGE\", \"SEX\", \"DIAGNOSIS\")\ninteraction <- c(\"timedays,DIAGNOSIS\")\nbatch       <- \"site\"\n\n# harmonize reference data\nref_model <- combat_harm(\n  type        = \"lmer\",\n  features    = features,\n  batch       = batch,\n  covariates  = covariates,\n  interaction = interaction,\n  smooth      = NULL,\n  random      = \"subid\",\n  df          = reference_df\n)\n\n# harmonize new data to the reference data\nharm_new <- combat_harm(\n  type        = \"lmer\",\n  features    = features,\n  batch       = batch,\n  covariates  = covariates,\n  interaction = interaction,\n  smooth      = NULL,\n  random      = \"subid\",\n  df          = adni,\n  reference   = ref_model$harmonized_df\n)\n```\n:::\n\n:::\n\n\n::: {.callout-tip .cli-only collapse=\"true\"}\n## CLI code: Out-of-sample using Reference Data\nUsing the command-line interface requires users to set the following parameter:\n\n-   `--reference`: Path to the reference dataset \n\n::: {.cell class='highlight-chunk'}\n\n```{.bash .cell-code}\nRscript path/to/combatQC_CLI.R \\\n  path/to/unharmonized_data.csv \\\n  -d FALSE \\\n  --features 43-104 \\\n  --covariates 9,11,13-14 \\\n  -b 16 \\\n  -i 9*14 \\\n  -m lmer \\\n  -r 3 \\\n  --reference path/to/reference.csv \\\n  --outdir /path/to/harmonized_data.csv \\\n  --mout  /path/to/saved_model.rds\n```\n:::\n\n:::\n\n\n<style>\n.mode-toggle {\n  position: sticky;\n  top: 0;\n  z-index: 1000;\n  background: var(--quarto-body-bg, #fff);\n  padding: .5rem 0;\n  border-bottom: 1px solid rgba(0,0,0,.05);\n}\n.hidden-by-toggle { display: none !important; }\n</style>\n\n<script>\n(function(){\n  const btnR = document.getElementById('btn-r');\n  const btnCli = document.getElementById('btn-cli');\n\n  // Restore preferences from localStorage\n  let showR = true;\n  let showCli = false;\n\n  try {\n    const saved = JSON.parse(localStorage.getItem('preferredModes'));\n    if (saved) {\n      showR = saved.showR ?? true;\n      showCli = saved.showCli ?? false;\n    }\n  } catch(e){}\n\n  function updateVisibility() {\n    const rEls = document.querySelectorAll('.r-only');\n    const cliEls = document.querySelectorAll('.cli-only');\n\n    rEls.forEach(el => el.classList.toggle('hidden-by-toggle', !showR));\n    cliEls.forEach(el => el.classList.toggle('hidden-by-toggle', !showCli));\n\n    // Button styles\n    btnR.classList.toggle('btn-primary', showR);\n    btnR.classList.toggle('btn-outline-primary', !showR);\n    btnCli.classList.toggle('btn-primary', showCli);\n    btnCli.classList.toggle('btn-outline-primary', !showCli);\n\n    // Save preferences\n    try {\n      localStorage.setItem('preferredModes', JSON.stringify({showR, showCli}));\n    } catch(e){}\n  }\n\n  btnR.addEventListener('click', ()=>{\n    showR = !showR;\n    updateVisibility();\n  });\n\n  btnCli.addEventListener('click', ()=>{\n    showCli = !showCli;\n    updateVisibility();\n  });\n\n  updateVisibility();\n})();\n</script>\n\n\n# Learn More\n- Refer to the [**Example: Post Harmonization**](post.qmd) for a detailed illustration of post harmonization analysis in application.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}