<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ComBatFamQC - ComBat Methods Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">ComBatFamQC</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"><i class="bi bi-play-circle" role="img">
</i> 
 <span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./method.html" aria-current="page"><i class="bi bi-book" role="img">
</i> 
 <span class="menu-text">Methods Guide</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-example" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-file-text" role="img">
</i> 
 <span class="menu-text">Example</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-example">    
        <li>
    <a class="dropdown-item" href="./diagnostic.html"><i class="bi bi-window" role="img">
</i> 
 <span class="dropdown-text">Batch Effect Diagnosis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./harmonization.html"><i class="bi bi-clipboard-data" role="img">
</i> 
 <span class="dropdown-text">Harmonization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./post.html"><i class="bi bi-graph-up" role="img">
</i> 
 <span class="dropdown-text">Post-Harmonization Downstream Analysis</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./tutorial.html"><i class="bi bi-youtube" role="img">
</i> 
 <span class="menu-text">Tutorials</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./references.html"><i class="bi bi-archive" role="img">
</i> 
 <span class="menu-text">References</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./news.html"><i class="bi bi-newspaper" role="img">
</i> 
 <span class="menu-text">News</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./help.html"><i class="bi bi-question-circle" role="img">
</i> 
 <span class="menu-text">Help</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Zheng206/ComBatFamQC"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#combat" id="toc-combat" class="nav-link active" data-scroll-target="#combat">ComBat</a></li>
  <li><a href="#combat-gam" id="toc-combat-gam" class="nav-link" data-scroll-target="#combat-gam">ComBat GAM</a></li>
  <li><a href="#longitudinal-combat" id="toc-longitudinal-combat" class="nav-link" data-scroll-target="#longitudinal-combat">Longitudinal ComBat</a></li>
  <li><a href="#covbat" id="toc-covbat" class="nav-link" data-scroll-target="#covbat">CovBat</a></li>
  <li><a href="#out-of-sample-harmonization" id="toc-out-of-sample-harmonization" class="nav-link" data-scroll-target="#out-of-sample-harmonization">Out-of-Sample Harmonization</a>
  <ul class="collapse">
  <li><a href="#using-saved-combat-model" id="toc-using-saved-combat-model" class="nav-link" data-scroll-target="#using-saved-combat-model">Using Saved ComBat Model</a></li>
  <li><a href="#toward-reference-data" id="toc-toward-reference-data" class="nav-link" data-scroll-target="#toward-reference-data">Toward Reference Data</a></li>
  </ul></li>
  <li><a href="#learn-more" id="toc-learn-more" class="nav-link" data-scroll-target="#learn-more">Learn more</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ComBat Methods Guide</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This guide provides an overview of the harmonization methods implemented in <strong><span style="color:#C83F49">ComBatFamQC</span></strong>, designed to help users identify which approach best fits their specific study conditions and data characteristics. Multi-site neuroimaging studies often face challenges due to site- or scanner-related variability, known as batch effects, which can obscure true biological signals. The methods described here (ComBat, ComBat-GAM, Longitudinal ComBat, CovBat, and Out-of-Sample Harmonization) offer flexible solutions for correcting these effects across different analytical contexts.</p>
<ul>
<li><p><strong><span style="color:#6082B6">ComBat</span></strong> is suitable for cross-sectional data with linear covariate effects.</p></li>
<li><p><strong><span style="color:#6082B6">ComBat-GAM</span></strong> handles nonlinear relationships such as age effects.</p></li>
<li><p><strong><span style="color:#6082B6">Longitudinal ComBat</span></strong> accommodates repeated measures and within-subject correlations.</p></li>
<li><p><strong><span style="color:#6082B6">CovBat</span></strong> harmonizes covariance structures, ideal for multivariate or network analyses.</p></li>
<li><p><strong><span style="color:#40B5AD">Out-of-Sample Harmonization</span></strong> enables consistent adjustment of new datasets using previously fitted models or reference data.</p></li>
</ul>
<p>By understanding the assumptions and strengths of each method, researchers can select the most appropriate harmonization strategy to ensure their analyses are both comparable across sites and biologically meaningful.</p>
<hr>
<p><strong>In Sample Harmonization</strong> in ComBat means training a harmonization model <span style="color:#93C572">using existing data</span>.</p>
<section id="combat" class="level2">
<h2 class="anchored" data-anchor-id="combat">ComBat</h2>
<p>ComBat is a statistical method used to correct for batch effect in neuroimaging data. In multi-site neuroimaging studies, technical variations can introduce unwanted differences (known as batch effect) that can mask true brain related findings. ComBat applies an empirical Bayes approach to harmonize imaging measurements(like cortical thickness) across batches, while preserving biological and clinical variability. This improves the comparability of neuroimaging results from different sources.</p>
<p>ComBat assumes batch effects exist in the mean and variance of multivariate observations and assumes linear relationships between covariates and features. For site/scanner <span class="math inline">\(i\)</span>, subject <span class="math inline">\(j\)</span> and feature at location <span class="math inline">\(v\)</span>,</p>
<p><span class="math display">\[
y_{ijv} = \alpha_v + X_{ij}^T \beta_v + \gamma_{iv} + \delta_{iv} e_{ijv}
\]</span> where <span class="math inline">\(\alpha_{v}\)</span> is the intercept, <span class="math inline">\(X_{ij}\)</span> is the vector of covariates, <span class="math inline">\(\beta_{v}\)</span> is the vector of regression coefficients, <strong><span class="math inline">\(\gamma_{iv}\)</span></strong> is the mean site effect, and <strong><span class="math inline">\(\delta_{iv}\)</span></strong> is the variance site effect. The error <span class="math inline">\(e_{ijv}\)</span> are assumed to independently follow <span class="math inline">\(e_{ijv}\sim N(0,{\sigma_{v}}^2)\)</span>.</p>
</section>
<section id="combat-gam" class="level2">
<h2 class="anchored" data-anchor-id="combat-gam">ComBat GAM</h2>
<p>ComBat-GAM is an extension of the ComBat method that corrects for batch effects in neuroimaging data using generalized additive models (GAM). In multi-site neuroimaging studies, batch effects arise from both technical differences and complex, nonlinear biological variables such as age. ComBat-GAM addresses this <strong>by incorporating flexible, nonlinear modeling of covariates like age and sex</strong>, enabling more accurate harmonization of imaging measures (e.g., cortical thickness) across sites. ComBat-GAM assumes that batch effects exist in both the mean and variance of multivariate observations, and that the relationship between covariates and features can be flexibly nonlinear, modeled using Generalized Additive Models (GAMs). For site/scanner <span class="math inline">\(i\)</span>, subject <span class="math inline">\(j\)</span> and feature at location <span class="math inline">\(v\)</span>,</p>
<p><span class="math display">\[
y_{ijv} = \alpha_v + f(X_{ij}) + \gamma_{iv} + \delta_{iv} e_{ijv}
\]</span> where <span class="math inline">\(\alpha_{v}\)</span> is the intercept, <span class="math inline">\(X_{ij}\)</span> is the vector of covariates, <strong><span class="math inline">\(f(\cdot)\)</span></strong> is the smooth (nonlinear) function of covariates, <span class="math inline">\(\gamma_iv\)</span> is the mean site effect, and <span class="math inline">\(\delta_{iv}\)</span> is the variance site effect. The error <span class="math inline">\(e_{ijv}\)</span> are assumed to independently follow <span class="math inline">\(e_{ijv}\sim N(0,{\sigma_{v}}^2)\)</span>.</p>
</section>
<section id="longitudinal-combat" class="level2">
<h2 class="anchored" data-anchor-id="longitudinal-combat">Longitudinal ComBat</h2>
<p>Longitudinal ComBat extends the original ComBat method to harmonize neuroimaging data with repeated measurements from the same subjects over time. By modeling both batch effects and <strong>within-subject correlations</strong>, Longitudinal ComBat adjusts for site or scanner differences while preserving individual longitudinal trajectories. This approach improves the comparability of multi-site longitudinal studies without removing true biological changes over time. Longitudinal ComBat assumes that batch effects exist in both the mean and variance of multivariate observations aross time, and assumes repeated measures from the same subject are correlated, and it explicitly models these correlations using random effects. For site/scanner <span class="math inline">\(i\)</span>, subject <span class="math inline">\(j\)</span>, feature at location <span class="math inline">\(v\)</span> and time point <span class="math inline">\(t\)</span>, the model can be expressed as:</p>
<p><span class="math display">\[
y_{ijv}(t) = \alpha_v + X_{ij}^T(t) \beta_v + \eta_{ijv} + \gamma_{iv} + \delta_{iv} e_{ijv}(t)
\]</span> where <span class="math inline">\(\alpha_{v}\)</span> is the intercept, <span class="math inline">\(X_{ij}(t)\)</span> is the time-varying covariates, <span class="math inline">\(\beta_{v}\)</span> is the vector of regression coefficients, <strong><span class="math inline">\(\eta_{ijv}\)</span> is the subject-specific random effect</strong>, <span class="math inline">\(\gamma_{iv}\)</span> is the mean site effect, and <span class="math inline">\(\delta_{iv}\)</span> is the variance site effect. The time-varying error <span class="math inline">\(e_{ijv}(t)\)</span> is assumed to independently follow <span class="math inline">\(e_{ijv}(t) \sim N(0, \sigma_{v}^2)\)</span>.</p>
</section>
<section id="covbat" class="level2">
<h2 class="anchored" data-anchor-id="covbat">CovBat</h2>
<p>CovBat extends the original ComBat method by harmonizing not only the mean and variance, but also <strong>the covariance batch effects</strong> of neuroimaging data across sites or batches. By adjusting for differences in how features co-vary between sites, CovBat preserves both biological variability and the intricate relationships among features. This method is valuable for multivariate analyses (such as connectivity or network studies) and machine learning applications, as it enhances the comparability of data from multiple sources while maintaining the integrity of underlying biological patterns.</p>
<p><span class="math display">\[y_{ijv} = \alpha_v + X_{ij}^T \beta_v + \gamma_{iv} + \delta_{iv} e_{ijv}\]</span></p>
<p>where <span class="math inline">\(\alpha_v\)</span> is the intercept, <span class="math inline">\(X_{ij}\)</span> is the covariates, <span class="math inline">\(\beta_v\)</span> is the vector of regression coefficients, and <span class="math inline">\(\gamma_{iv}\)</span> is the mean site effect. The residuals are modeled as <span class="math inline">\(e_{ij} = (e_{ij1}, e_{ij2}, \ldots, e_{ijp})^T \sim N(0, \Sigma_i)\)</span>, where <span class="math inline">\(\Sigma_i\)</span> is the site-specific covariance matrix that captures covariance differences across sites.</p>
<p>CovBat addresses covariance differences by using principal component analysis (PCA) on the residuals to align each site’s covariance structure to the pooled covariance across all sites.</p>
</section>
<section id="out-of-sample-harmonization" class="level2">
<h2 class="anchored" data-anchor-id="out-of-sample-harmonization">Out-of-Sample Harmonization</h2>
<hr>
<p><strong>Out-of-sample harmonization</strong> refers to the process of applying a <span style="color:#93C572">previously trained harmonization model</span> to new, incoming data that was not available during the initial model training phase.</p>
<section id="using-saved-combat-model" class="level3">
<h3 class="anchored" data-anchor-id="using-saved-combat-model">Using Saved ComBat Model</h3>
<p>Out-of-sample harmonization using a saved ComBat model means you first adjust your original data and save the ComBat model, then later use that saved model to correct batch effects in any new data, making it comparable to your original dataset.</p>
<p><img src="figure/using_save.png" width="78%" style="display: block; margin: auto;"></p>
<p><strong>Example</strong>: You harmonize batch effects in Batch A and save the ComBat model. When you later receive Batch B, you apply the saved model so Batch B is adjusted using the same batch-correction parameters as Batch A, ensuring the two batches are directly comparable</p>
</section>
<section id="toward-reference-data" class="level3">
<h3 class="anchored" data-anchor-id="toward-reference-data">Toward Reference Data</h3>
<p>Out-of-sample harmonization toward Reference Data involves fitting the ComBat model on the reference dataset and then applying the estimated parameters to new data, so that the new data are standardized to the batch-corrected distribution of the reference.</p>
<p><img src="figure/toward.png" width="95%" style="display: block; margin: auto;"></p>
<p><strong>Example</strong>: You choose a high-quality multi-site study as your reference and keep it unchanged. When new data come in, you harmonize them, so they are brought into the same batch-corrected distribution as the reference study.</p>
</section>
</section>
<section id="learn-more" class="level1">
<h1>Learn more</h1>
<p>Dive into the <a href="./diagnostic.html"><strong>Example: Batch Effect Diagnosis</strong></a> to explore how batch effects are identified and analyzed.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>